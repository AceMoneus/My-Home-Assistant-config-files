
#######################################################
# Configuration for ESP32-S3-Relay-1CH
# https://www.waveshare.com/wiki/ESP32-S3-Relay-1CH

esphome:
  name: waveshare-relay-1ch
  friendly_name: "Waveshare 1CH Relay"

esp32:
  board: esp32-s3-devkitc-1
  framework:
    type: arduino

logger:

api:
  encryption:
    key: !secret encryption_key

ota:
  - platform: esphome
    password: !secret ota_password

safe_mode:

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  ap:
    ssid: !secret fallback_ssid
    password: !secret fallback_password

captive_portal:

uart:
  id: rs485_uart
  tx_pin: GPIO17  # Waveshare RS485 TX
  rx_pin: GPIO18  # Waveshare RS485 RX
  baud_rate: 19200
  parity: EVEN
  stop_bits: 1

modbus:
  id: modbus_hub
  uart_id: rs485_uart

modbus_controller:
  - id: ecl_controller
    address: 0x01  # ECL-110's Modbus-adress
    modbus_id: modbus_hub
    update_interval: 10s

# Läs temperaturer som sensorer (×0.1 °C skalning)
sensor:
  - platform: modbus_controller
    modbus_controller_id: ecl_controller
    name: "Uutside temperature"
    id: outdoor_temp
    register_type: holding
    address: 11200
    value_type: S_WORD  # Signed 16-bit
    unit_of_measurement: "°C"
    filters:
      - multiply: 0.1  # Scale to °C
      - or:
        - lambda: 'return (x == 192.0) ? NAN : x;'  # 192 = not connected → NaN

  - platform: modbus_controller
    modbus_controller_id: ecl_controller
    name: "Actual room temperature"
    id: room_temp
    register_type: holding
    address: 11201
    value_type: S_WORD
    unit_of_measurement: "°C"
    filters:
      - multiply: 0.1
      - or:
        - lambda: 'return (x == 192.0) ? NAN : x;'

  - platform: modbus_controller
    modbus_controller_id: ecl_controller
    name: "Output temperature"
    id: supply_temp
    register_type: holding
    address: 11202
    value_type: S_WORD
    unit_of_measurement: "°C"
    filters:
      - multiply: 0.1
      - or:
        - lambda: 'return (x == 192.0) ? NAN : x;'

  - platform: modbus_controller
    modbus_controller_id: ecl_controller
    name: "Return temperature"
    id: return_temp
    register_type: holding
    address: 11203
    value_type: S_WORD
    unit_of_measurement: "°C"
    filters:
      - multiply: 0.1
      - or:
        - lambda: 'return (x == 192.0) ? NAN : x;'

  - platform: modbus_controller
    modbus_controller_id: ecl_controller
    name: "Requested room temperature"
    id: desired_room_temp
    register_type: holding
    address: 11179
    value_type: S_WORD
    unit_of_measurement: "°C"
    filters:
      - multiply: 0.1

# Setpoint/mode (number for value)
number:
  - platform: modbus_controller
    modbus_controller_id: ecl_controller
    name: "Max flow temperature"
    id: max_flow_temp
    register_type: holding
    address: 11177
    value_type: S_WORD
    min_value: 0
    max_value: 150
    step: 0.5
    lambda: |-
      return x * 0.1;
    write_lambda: |-
      return x * 10;

# Mode-change (switch or select for AUTO/COMFORT etc.)
select:
  - platform: modbus_controller
    modbus_controller_id: ecl_controller
    name: "ECL mode"
    id: ecl_mode
    address: 4200
    value_type: U_WORD
    optionsmap:
      "AUTO": 1
      "COMFORT": 2
      "SETBACK": 3
      "STANDBY": 4

# Relay
switch:
  - platform: gpio
    pin: GPIO48
    name: "Relay"