#######################################################
# Configuration for Waveshare ESP32-S3-LCD-2
# Based on:
# ESP32-S3 (LX7, 240MHz)
# Configure as Arduino/esp32-s3-devkitc-1
# i2c frequency: 100000 (50k in documentation did not work)
#
# Touch: cst816 rotation not supported, done mathematically
# id(touch_xr) = 320 - touch.x;
# id(touch_yr) = touch.y;
#
# https://files.waveshare.com/upload/5/51/CST816S_Datasheet_EN.pdf
#
# Display: st7789T3 (ili9xxx/st7789v the only one that seems to work)
# https://files.waveshare.com/wiki/2.8inch-Capacitive-Touch-LCD/ST7789T3_SPEC_V1.0.pdf
#######################################################
esphome:
  name: esphome-display-1
  friendly_name: ESPHome Display 1
  min_version: 2026.1.0

esp32:
  board: esp32-s3-devkitc-1
  framework:
    type: arduino

api:
  services:
    - service: force_display_refresh
      then:
        - lambda: |-
            id(needs_redraw) = true;

packages:
  network: !include common/network.yaml
  system: !include common/system.yaml
  firmware: !include common/firmware.yaml

#######################################################
# GLOBALS
globals:
  - id: fw_version
    type: std::string
    restore_value: no
    initial_value: "\"v1.2.0\""
  - id: uptime_seconds
    type: int
    restore_value: no
    initial_value: '0'
  - id: ha_last_update
    type: int
    restore_value: no
    initial_value: '0'
  - id: touch_xr
    type: int
    restore_value: no
    initial_value: '0'
  - id: touch_yr
    type: int
    restore_value: no
    initial_value: '0'
  - id: needs_redraw
    type: bool
    restore_value: no
    initial_value: 'true'

#######################################################
psram:
  mode: octal
  speed: 80MHz

time:
  - platform: homeassistant
    id: ha_time
    on_time_sync:
      then:
        - lambda: |-
            id(ha_last_update) = id(uptime_seconds);
    on_time:
      - seconds: 0
        minutes: /1
        then:
          - component.update: esphome_display_1

#######################################################
# SENSORER
sensor:
  - platform: homeassistant
    id: ha_outside_temperature
    entity_id: sensor.outside_temperature
    on_value:
      then:
        - lambda: |-
            id(ha_last_update) = id(uptime_seconds);
        - component.update: esphome_display_1
  - platform: homeassistant
    id: ha_inside_temperature
    entity_id: sensor.inside_temperature
    on_value:
      then:
        - lambda: |-
            id(ha_last_update) = id(uptime_seconds);
        - component.update: esphome_display_1
  - platform: homeassistant
    id: ha_lampor_state
    entity_id: sensor.mqtt_lampor_numeric
    on_value:
      then:
        - lambda: |-
            id(ha_last_update) = id(uptime_seconds);
        - component.update: esphome_display_1
  - platform: homeassistant
    id: ha_bettan_state
    entity_id: sensor.mqtt_bettan_numeric
    on_value:
      then:
        - lambda: |-
            id(ha_last_update) = id(uptime_seconds);
        - component.update: esphome_display_1
  - platform: homeassistant
    id: ha_kjell_state
    entity_id: sensor.mqtt_kjell_numeric
    on_value:
      then:
        - lambda: |-
            id(ha_last_update) = id(uptime_seconds);
        - component.update: esphome_display_1

#######################################################
# HARDWARE
spi:
  clk_pin: GPIO39
  mosi_pin: GPIO38

i2c:
  sda: GPIO48
  scl: GPIO47
  frequency: 400000
  scan: true

output:
  - platform: ledc
    pin: GPIO1
    id: backlight_pwm

light:
  - platform: monochromatic
    output: backlight_pwm
    name: "Display Backlight"
    restore_mode: ALWAYS_ON

#######################################################
# FONTER
font:
  - file: "gfonts://Roboto"
    id: font_medium
    size: 18
    glyphs: " !\"#%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~°åäöÅÄÖéÉ"
  - file: "gfonts://Roboto"
    id: font_large
    size: 24
    glyphs: " !\"#%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~°åäöÅÄÖéÉ"
  - file: "gfonts://Roboto"
    id: font_huge
    size: 40
    glyphs: " !\"#%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~°åäöÅÄÖéÉ"

#######################################################
# DISPLAY
display:
  - platform: ili9xxx
    model: st7789v
    cs_pin: GPIO45
    dc_pin: GPIO42
    reset_pin: GPIO41
    rotation: 90
    invert_colors: true
    id: esphome_display_1
    update_interval: never
    pages:
      - id: main_page
        lambda: |-
          bool lampor_on = (id(ha_lampor_state).state == 1.0f);
          bool bettan_on = (id(ha_bettan_state).state == 1.0f);
          bool kjell_on  = (id(ha_kjell_state).state == 1.0f);

          it.fill(Color(0,0,0));

          it.print(160, 14, id(font_medium), Color(255,255,255), TextAlign::CENTER,
                   "Lampor, Kupévärmare & Temperatur");

          it.filled_rectangle(10, 40, 140, 60, Color(64,64,64));
          it.print(80, 52, id(font_medium), Color(0,255,255), TextAlign::CENTER, "Ute:");
          if (id(ha_outside_temperature).has_state()) {
            it.printf(80, 80, id(font_huge), Color(0,255,255), TextAlign::CENTER,
                      "%.1f°C", id(ha_outside_temperature).state);
          }

          it.filled_rectangle(170, 40, 140, 60, Color(64,64,64));
          it.print(240, 52, id(font_medium), Color(255,165,0), TextAlign::CENTER, "Inne:");
          if (id(ha_inside_temperature).has_state()) {
            it.printf(240, 80, id(font_huge), Color(255,165,0), TextAlign::CENTER,
                      "%.1f°C", id(ha_inside_temperature).state);
          }

          if (lampor_on) it.filled_rectangle(10,120,96,50,Color(255,0,0));
          else it.rectangle(10,120,96,50);
          it.print(58,145,id(font_medium),Color(255,255,255),TextAlign::CENTER,"Lampor");

          if (bettan_on) it.filled_rectangle(116,120,96,50,Color(255,0,0));
          else it.rectangle(116,120,96,50);
          it.print(164,133,id(font_medium),Color(255,255,255),TextAlign::CENTER,"Bettans");
          it.print(164,153,id(font_large),Color(255,255,255),TextAlign::CENTER,"bil");

          if (kjell_on) it.filled_rectangle(222,120,96,50,Color(255,0,0));
          else it.rectangle(222,120,96,50);
          it.print(270,133,id(font_medium),Color(255,255,255),TextAlign::CENTER,"Kjells");
          it.print(270,153,id(font_large),Color(255,255,255),TextAlign::CENTER,"bil");

          auto now = id(ha_time).now();

          const char* weekdays_sv[] = {
            "Söndag", "Måndag", "Tisdag", "Onsdag",
            "Torsdag", "Fredag", "Lördag"
          };
          std::string weekday = weekdays_sv[now.day_of_week];

          char date_str[32];
          now.strftime(date_str, sizeof(date_str), "%d %B");

          char time_str[6];
          now.strftime(time_str, sizeof(time_str), "%H:%M");

          it.print(10, 185, id(font_large), Color(255,255,255), TextAlign::LEFT, weekday.c_str());
          it.print(10, 215, id(font_large), Color(255,255,255), TextAlign::LEFT, date_str);

          it.print(310, 190, id(font_huge), Color(255,255,255), TextAlign::RIGHT, time_str);

      - id: error_page
        lambda: |-
          it.fill(Color(0,0,0));
          it.print(160,120,id(font_large),Color(255,0,0),TextAlign::CENTER,
                   "Ingen kontakt med HA!");

#######################################################
# TOUCH - MED TESTLÄGE
touchscreen:
  - platform: cst816
    id: my_touchscreen
    interrupt_pin: GPIO46
    reset_pin: GPIO8
    address: 0x15
    skip_probe: false
    on_touch:
      - lambda: |-
          id(touch_xr) = 320 - touch.x;
          id(touch_yr) = touch.y;
          
          ESP_LOGI("touch", "===========================================");
          ESP_LOGI("touch", "RAW: x=%d, y=%d", touch.x, touch.y);
          ESP_LOGI("touch", "DISPLAY: xr=%d, yr=%d", id(touch_xr), id(touch_yr));
          ESP_LOGI("touch", "===========================================");
      - if:
          condition:
            lambda: 'return (id(touch_xr) >= 10 && id(touch_xr) <= 106 && id(touch_yr) >= 120 && id(touch_yr) <= 170);'
          then:
            - logger.log: ">>> LAMPOR <<<"
            - homeassistant.service:
                service: switch.toggle
                data:
                  entity_id: switch.home_mqtt_light_button
      - if:
          condition:
            lambda: 'return (id(touch_xr) >= 116 && id(touch_xr) <= 212 && id(touch_yr) >= 120 && id(touch_yr) <= 170);'
          then:
            - logger.log: ">>> BETTANS <<<"
            - homeassistant.service:
                service: switch.toggle
                data:
                  entity_id: switch.home_mqtt_bettan_carheat
      - if:
          condition:
            lambda: 'return (id(touch_xr) >= 222 && id(touch_xr) <= 318 && id(touch_yr) >= 120 && id(touch_yr) <= 170);'
          then:
            - logger.log: ">>> KJELLS <<<"
            - homeassistant.service:
                service: switch.toggle
                data:
                  entity_id: switch.home_mqtt_kjell_carheat

#######################################################
# INTERVAL
interval:
  - interval: 1s
    then:
      - lambda: |-
          id(uptime_seconds) += 1;
          int diff = id(uptime_seconds) - id(ha_last_update);

          if (diff > 120) {
            id(esphome_display_1).show_page(id(error_page));
          } else {
            id(esphome_display_1).show_page(id(main_page));
          }
          id(esphome_display_1).update();