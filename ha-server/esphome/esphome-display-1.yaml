#######################################################
# Configuration for Waveshare ESP32-S3-LCD-2
# Based on:
# ESP32-S3 (LX7, 240MHz)
# Configure as Arduino/esp32-s3-devkitc-1
# i2c frequency: 100000 (50k in documentation did not work)
#
# Touch: cst816 note: rotation not supported, done mathematically
# int xr = 320 - touch.y;   // rotate & mirror
# int yr = touch.x;         // move up
#
# https://files.waveshare.com/upload/5/51/CST816S_Datasheet_EN.pdf
#
# Display: st7789T3 (ili9xxx/st7789v the only one that seems to work)
# https://files.waveshare.com/wiki/2.8inch-Capacitive-Touch-LCD/ST7789T3_SPEC_V1.0.pdf

esphome:
  name: esphome-display-1
  friendly_name: ESPHome Display 1
  on_boot:
    priority: 600
    then:
      - delay: 2s
      - lambda: |-
          ESP_LOGI("boot", "=== SYSTEM BOOT COMPLETE ===");
          id(needs_redraw) = true;

esp32:
  board: esp32-s3-devkitc-1
  framework:
    type: arduino

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  ap:
    ssid: !secret fallback_ssid
    password: !secret fallback_password

captive_portal:

logger:
  level: WARN

api:
  encryption:
    key: !secret encryption_key

  services:
    - service: refresh
      then:
        - lambda: |-
            id(ha_last_update) = id(uptime_seconds);
            id(needs_redraw) = true;
  reboot_timeout: 0s

ota:
  - platform: esphome
    password: !secret ota_password

time:
  - platform: homeassistant
    id: ha_time
    on_time:
      - seconds: 0
        minutes: /1
        then:
          - lambda: |-
              id(needs_redraw) = true;

#######################################################
# SENSORER
sensor:
  - platform: homeassistant
    id: ha_outside_temperature
    entity_id: sensor.outside_temperature
    on_value:
      then:
        - lambda: |-
            id(ha_last_update) = id(uptime_seconds);
            id(needs_redraw) = true;
  - platform: homeassistant
    id: ha_inside_temperature
    entity_id: sensor.inside_temperature
    on_value:
      then:
        - lambda: |-
            id(ha_last_update) = id(uptime_seconds);
            id(needs_redraw) = true;
  - platform: homeassistant
    id: ha_lampor_state
    entity_id: sensor.mqtt_lampor_numeric
    on_value:
      then:
        - lambda: |-
            id(ha_last_update) = id(uptime_seconds);
            id(needs_redraw) = true;
  - platform: homeassistant
    id: ha_bettan_state
    entity_id: sensor.mqtt_bettan_numeric
    on_value:
      then:
        - lambda: |-
            id(ha_last_update) = id(uptime_seconds);
            id(needs_redraw) = true;
  - platform: homeassistant
    id: ha_kjell_state
    entity_id: sensor.mqtt_kjell_numeric
    on_value:
      then:
        - lambda: |-
            id(ha_last_update) = id(uptime_seconds);
            id(needs_redraw) = true;

#######################################################
# GLOBALS
globals:
  - id: uptime_seconds
    type: int
    restore_value: no
    initial_value: '0'
  - id: ha_last_update
    type: int
    restore_value: no
    initial_value: '0'
  - id: needs_redraw
    type: bool
    restore_value: no
    initial_value: 'true'
  - id: touch_xr
    type: int
    restore_value: no
    initial_value: '0'
  - id: touch_yr
    type: int
    restore_value: no
    initial_value: '0'

#######################################################
# HARDWARE
spi:
  clk_pin: GPIO39
  mosi_pin: GPIO38

i2c:
  sda: GPIO48
  scl: GPIO47
  frequency: 100000
  scan: true

output:
  - platform: ledc
    pin: GPIO1
    id: backlight_pwm

light:
  - platform: monochromatic
    output: backlight_pwm
    name: "Display Backlight"
    restore_mode: ALWAYS_ON

#######################################################
# FONTER
font:
  - file: "gfonts://Roboto"
    id: font_medium
    size: 18
    glyphs: " !\"#%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~°åäöÅÄÖéÉ"
  - file: "gfonts://Roboto"
    id: font_large
    size: 24
    glyphs: " !\"#%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~°åäöÅÄÖéÉ"
  - file: "gfonts://Roboto"
    id: font_huge
    size: 40
    glyphs: " !\"#%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~°åäöÅÄÖéÉ"

#######################################################
# DISPLAY
display:
  - platform: ili9xxx
    model: st7789v
    cs_pin: GPIO45
    dc_pin: GPIO42
    reset_pin: GPIO41
    rotation: 270
    invert_colors: true
    id: my_display
    update_interval: never
    pages:
      - id: main_page
        lambda: |-
          if (!id(needs_redraw)) return;

          bool lampor_on = (id(ha_lampor_state).state == 1.0f);
          bool bettan_on = (id(ha_bettan_state).state == 1.0f);
          bool kjell_on  = (id(ha_kjell_state).state == 1.0f);

          it.fill(Color(0,0,0));

          it.print(160, 14, id(font_medium), Color(255,255,255), TextAlign::CENTER,
                   "Lampor, Kupévärmare & Temperatur");

          it.filled_rectangle(10, 40, 140, 60, Color(64,64,64));
          it.print(80, 52, id(font_medium), Color(0,255,255), TextAlign::CENTER, "Ute:");
          if (id(ha_outside_temperature).has_state()) {
            it.printf(80, 80, id(font_huge), Color(0,255,255), TextAlign::CENTER,
                      "%.1f°C", id(ha_outside_temperature).state);
          }

          it.filled_rectangle(170, 40, 140, 60, Color(64,64,64));
          it.print(240, 52, id(font_medium), Color(255,165,0), TextAlign::CENTER, "Inne:");
          if (id(ha_inside_temperature).has_state()) {
            it.printf(240, 80, id(font_huge), Color(255,165,0), TextAlign::CENTER,
                      "%.1f°C", id(ha_inside_temperature).state);
          }

          if (lampor_on) it.filled_rectangle(10,120,96,50,Color(255,0,0));
          else it.rectangle(10,120,96,50);
          it.print(58,145,id(font_medium),Color(255,255,255),TextAlign::CENTER,"Lampor");

          if (bettan_on) it.filled_rectangle(116,120,96,50,Color(255,0,0));
          else it.rectangle(116,120,96,50);
          it.print(164,133,id(font_medium),Color(255,255,255),TextAlign::CENTER,"Bettans");
          it.print(164,153,id(font_large),Color(255,255,255),TextAlign::CENTER,"bil");

          if (kjell_on) it.filled_rectangle(222,120,96,50,Color(255,0,0));
          else it.rectangle(222,120,96,50);
          it.print(270,133,id(font_medium),Color(255,255,255),TextAlign::CENTER,"Kjells");
          it.print(270,153,id(font_large),Color(255,255,255),TextAlign::CENTER,"bil");

          auto now = id(ha_time).now();

          const char* weekdays_sv[] = {
            "Söndag", "Måndag", "Tisdag", "Onsdag",
            "Torsdag", "Fredag", "Lördag"
          };
          std::string weekday = weekdays_sv[now.day_of_week];

          char date_str[32];
          now.strftime(date_str, sizeof(date_str), "%d %B");

          char time_str[6];
          now.strftime(time_str, sizeof(time_str), "%H:%M");

          it.print(10, 185, id(font_large), Color(255,255,255), TextAlign::LEFT, weekday.c_str());
          it.print(10, 215, id(font_large), Color(255,255,255), TextAlign::LEFT, date_str);

          it.print(310, 190, id(font_huge), Color(255,255,255), TextAlign::RIGHT, time_str);

          id(needs_redraw) = false;
      - id: error_page
        lambda: |-
          if (!id(needs_redraw)) return;

          it.fill(Color(0,0,0));
          it.print(160,120,id(font_large),Color(255,0,0),TextAlign::CENTER,
                   "Ingen kontakt med Home Assistant!");

          id(needs_redraw) = false;

#######################################################
# TOUCH
touchscreen:
  - platform: cst816
    id: my_touchscreen
    interrupt_pin: GPIO46
    reset_pin: GPIO8
    address: 0x15
    skip_probe: false
    on_touch:
      - lambda: |-
          int xr = 320 - touch.y;
          int yr = touch.x;
          id(touch_xr) = xr;
          id(touch_yr) = yr;
      - if:
          condition:
            lambda: 'return (id(touch_xr) >= 80 && id(touch_xr) <= 170 && id(touch_yr) >= 140 && id(touch_yr) <= 220);'
          then:
            - homeassistant.service:
                service: switch.toggle
                data:
                  entity_id: switch.home_mqtt_light_button
      - if:
          condition:
            lambda: 'return (id(touch_xr) >= 160 && id(touch_xr) <= 240 && id(touch_yr) >= 150 && id(touch_yr) <= 220);'
          then:
            - homeassistant.service:
                service: switch.toggle
                data:
                  entity_id: switch.home_mqtt_bettan_carheat
      - if:
          condition:
            lambda: 'return (id(touch_xr) >= 240 && id(touch_xr) <= 320 && id(touch_yr) >= 160 && id(touch_yr) <= 240);'
          then:
            - homeassistant.service:
                service: switch.toggle
                data:
                  entity_id: switch.home_mqtt_kjell_carheat

#######################################################
# INTERVAL
interval:
  - interval: 1s
    then:
      - lambda: |-
          id(uptime_seconds) += 1;
          int diff = id(uptime_seconds) - id(ha_last_update);

          if (diff > 120) {
            id(my_display).show_page(id(error_page));
          } else {
            id(my_display).show_page(id(main_page));
          }
  - interval: 200ms
    then:
      - if:
          condition:
            lambda: 'return id(needs_redraw);'
          then:
            - component.update: my_display